---
title: "petrolprice - EDA"
author: "LinhNguyen"
date: "Monday, September 05, 2016"
output: pdf_document
---
Hey guys, thanks for your interest. In this analysis, we're going to explore the different between petrol price in Vietnam and in US.

For most Vietnamese who are living in Vietnam, we should all have the assumption, that we are paying so much more than our friends out there. But we never know how much...

That's the purpose of this exploratory data analysis, we are going to take a peek, at what the data has to tell us.

# Library
```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
library(xlsx) 
library(ggplot2)
library(tidyr)
library(dplyr)
library(RCurl)
```

# The data
- The US's petrol data are taken from the US Energy Information Association, available at:
http://www.eia.gov/petroleum/gasdiesel/

- The Vietnam's petrol data are gathered from petrolimex vietnam, available at:
http://www.petrolimex.com.vn/

- The currency exchange rate history are taken from oanda, available at:
https://www.oanda.com/currency/average

```{r Load the data and some preprocess}
# Vietnam's
## Oi, remember to set path for this one
oilvn <- "/gasolinevn.xlsx"
oilvn <- read.xlsx(oilvn, 1)
names(oilvn)[1] <- "date"
oilvn$year <- as.numeric(strftime(oilvn$date, format = "%Y"))

# US's Conventional midgrade petrol (Ron91 - Ron92)
rawus <- "https://raw.githubusercontent.com/Linhnguyen14/data/master/oilprice/gasolineus.csv"
oilus <- read.csv(text = getURL(rawus))
colnames(oilus) <- as.factor(c(1:21))

# History of currency rate (USD - VND)
curhistory <- "https://raw.githubusercontent.com/Linhnguyen14/data/master/oilprice/curhistory.csv"
curhistory <- read.csv(text = getURL(curhistory))

# I know, folks, we all love csv. But hey, sometimes, life gives you .xlsx.
```

# The wrangle
Got to admit it, this one really took a lot of effort, it was fun, tho.

So the idea is that, we want to let the data speak for itself:
- Since the price of Vietnam's petrol are controled by only one source, it will be best represent by a line graph.
- As for the US, there are a lot of people selling petrol, and the price varied from location to location, so the idea is that, we kind of want to let the audiences see the noises, the low, and the high of the prices, while not letting it become too much of a distraction.
- We want to show something that would sum the noise up, ideally a mean line in this case.
- We want to translate the US's price into vietnamese. To do so, we'll have to take in consideration the currency exchange rate of that given time.


```{r the Wrangle}
# Wrangling with the US's petrol data
# Turn the data from wide format to long format
oilus <- gather(oilus,"location","price", 2:21)
oilus <- subset(oilus, !is.na(oilus$price))
names(oilus)[1] <- "date"

# Reformat the date variable (us)
date <- as.character(oilus$date)
oilus$date <- as.Date(date, format = "%m/%d/%Y")
oilus$year <- as.numeric(strftime(oilus$date, format = "%Y"))
oilus$month <- as.numeric(strftime(oilus$date, format = "%m"))

# Group them by date, and take the mean of the oil price, since price fluctuate from loc to loc
oilusmean <- oilus %>%
  group_by(date) %>%
  summarise(mean = mean(price), sum = sum(price), n = n()) %>%
  arrange(date)
oilusmean$year <- as.numeric(strftime(oilusmean$date, format = "%Y"))
oilusmean$month <- as.numeric(strftime(oilusmean$date, format = "%m"))

# Wrangling the currency rate history:
# Reformat the date:
curhistory$date <- as.Date(as.character(curhistory$date), format = "%d%b%Y")
curhistory$price <- (curhistory$bid +curhistory$ask)/2
curhistory <- subset(curhistory, select = c(date, price))
curhistory$year <- as.numeric(strftime(curhistory$date, format = "%Y"))
curhistory$month <- as.numeric(strftime(curhistory$date, format = "%m"))

# Add merge point
curhistory <- curhistory %>%
  group_by(year, month) %>%
  summarise(price = mean(price), n = n()) 

# Join the petrol price with the currency rate
oilusmean <- left_join(oilusmean, curhistory, by = c("year", "month"))
oilus <- left_join(oilus, curhistory, by = c("year", "month"))

# Translate the US's price to VNS's price
litregallon <- 0.264172 #The rate of litre - gallon 
#usdvnd <- 20301.50      #The exchange rate of usd - vnd
oilusmean$priceinvnd <- oilusmean$price * oilusmean$mean * litregallon
oilus$priceinvnd <- oilus$price.x * oilus$price.y * litregallon
```

# The plot:
We kind of see it in here, the Vietnam's price are deliberately kept high, much much higher than the price.

Let us keep in mind, that gas companies in the US has to pay up to 20% in term of marketing.
Doubt if petrolimex has to do that at all, they are, after all, the sole provider of petrol in Vietnam.

If you look further back, before 2012, you will see something interesting. Turns out, petrolimex could do well, even when they set the price as high as others (remember the marketing things?)
It seems like, it turned out this way, mostly because the loss they took in investments and the extra tax from government.

Looking good, right?
Too good, I'm afraid. While this plot might successfully represent the change in price of the US's petrol, it didn't do a good job, when it came to Vietnam.

```{r the Plot}
ggplot(aes(x = date, y = priceinvnd), data = subset(oilus, year >2011)) + 
  geom_point(colour = "cadetblue1") +
  geom_line(aes(x = date, y = Ron.92.II.V1), 
            data = subset(oilvn, !is.na(oilvn$Ron.92.II.V1) & year > 2011), 
            size = 1.5, colour = "firebrick") +
  geom_line(aes(x = date, y = priceinvnd), 
            data = subset(oilusmean, !is.na(oilusmean$priceinvnd) & year > 2011),
            size = 1, colour = "forestgreen") +
  theme(panel.background = element_rect(fill = 'white'),
        plot.background = element_rect(fill = 'white')) 

  

```


### The wrangling, season 2
```{r}
# Wrangle the oilvn price
# Wrangle the oilvn price
# I'd advised you to stay out of this section, since it really is difficult to understand, even for me, read at your own risk!
# Too much information, let's only take the data that we use, which is the Ron.92.II.V1, because we could say, that it is the most regular used petrol type in vietnam.
oilvn <- subset(oilvn, !is.na(oilvn$Ron.92.II.V1), select = c(date,Ron.92.II.V1))

# The idea is that, unlike the US's price, where we could either use a line graph or a scatter plot to represent the data, the Vietnam's price are set by only one party, once setted, it will stay fixed, tilled setted again.
# Which means, neither a line-graph nor a scatter plot could accuraely represent the movement of price in vietnam. However a modified version of the line-graph will make it, where all the line are either parallel to the horizontal or the vertical line.
# The simplest solution I could think of to solve this, is to create a line-graph that goes throw some modified version of the data point, where:
# Original data:
# date         value
# a,            e
# b,            f
# c,            g

# Modified data:
# date     value
# a - 1      f
# b - 1      g
# c - 1      NA

# Then merge the original with the modified:
# date   value
# a        e
# a - 1    f
# b        f
# b - 1    g
# c        g
# c - 1    NA

#
# That way, we could create line-graph that best visualize the reality.

# Add the modified date collumn
oilvn$date2 <- as.Date(oilvn$date) - 1

# To keep track of them, we introduced a new id collumn, which run from 1 to 107, I did originally noticed the "row.names", but i don't know, tried a few times, couldn't really used it. Will invest some more time to study it, but not now.
oilvn$id <- c(1:107)

# We create 2 different data.frame to manipulate the data, and will merge them together later.
datedata <- subset(oilvn, select = c(id, date2))
pricedata <- subset(oilvn, select = c(id, Ron.92.II.V1))

# We remove the first row of datedata and the last row of pricedata, then merge them together.
# The end result: (this is really confusing, like I warned ya)
# c - 1   c   b - 1   b  a - 1   a   (timeline going forward)
# NA      g   g       f  f       e
# Remove the first row of pricedata
dim(pricedata)
pricedata <- pricedata[-1,]
dim(pricedata)

# Additional manipulation to put the price dataframe in shape
p <- subset(pricedata, id ==107)
p[1,2] <- NA
pricedata$id <- pricedata$id - 1
pricedata <- rbind(pricedata, p)

# Merge the date and the price data together
petrovn <- merge(datedata,pricedata, by = "id")
names(petrovn)[2] <- "date"

# Merge it with the original oil data set, then holy Marie, think its pretty much the end.
oilvn <- subset(oilvn, select = c(date, Ron.92.II.V1))
petrovn <- bind_rows(petrovn, oilvn)
petrovn$year <- as.numeric(strftime(petrovn$date, format = "%Y"))

```

### The plot, version final
Okay, yes, this is one ugly plot, I agree.
But hey, it is the one that could best represent reality, so I'd go with this one.

```{r}
ggplot(aes(x = date, y = priceinvnd), data = subset(oilus, year > 2011)) + 
  geom_point(colour = "palegreen") +
  geom_line(aes(x = date, y = priceinvnd), 
            data = subset(oilusmean, !is.na(oilusmean$priceinvnd) & year > 2011),
            size = 1, colour = "forestgreen") +
  geom_line(aes(x = date, y = Ron.92.II.V1),
            data = subset(petrovn, year > 2011), 
            size = 1.5, colour = "firebrick")+
  theme(panel.background = element_rect(fill = 'white'),
        plot.background = element_rect(fill = 'white')) +
  ylab("Petrol price in VND") +
  xlab("Year")

```

